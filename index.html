<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Partager ma position</title>
<style>body{font-family:system-ui,Arial;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;padding:20px}button{padding:12px 18px;border-radius:8px;font-size:16px}</style>
</head>
<body>
  <div>
    <h2>Partage ta position</h2>
    <p id="status">Appuie sur le bouton pour partager ta position.</p>
    <button id="btn">Partager ma position</button>
  </div>

<script>
const makeWebhook = "https://hook.eu1.make.com/8i2dij7l9qb6h1pu7jqyfw9o244rvl1s"; // <-- remplace par ton webhook Make
function getQuery(name){ try{ const u=new URL(location.href); return u.searchParams.get(name);}catch(e){return "";}}
const userIdFromQuery = getQuery("user_id") || "";

const status = document.getElementById("status");
const btn = document.getElementById("btn");

btn.addEventListener("click", () => {
  if (!navigator.geolocation) { status.textContent = "Ton navigateur ne supporte pas la géoloc."; return; }
  status.textContent = "Demande de position…";
  navigator.geolocation.getCurrentPosition(success, error, { enableHighAccuracy: true, timeout:15000 });
});

function success(pos){
  const lat = pos.coords.latitude;
  const lng = pos.coords.longitude;
  status.textContent = `Coord récupérées: ${lat.toFixed(5)}, ${lng.toFixed(5)} — j'envoie…`;

  const payload = {
    user_id: userIdFromQuery,
    latitude: lat,
    longitude: lng,
    timestamp: new Date().toISOString()
  };

  fetch(makeWebhook, {
    method: "POST",
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(r => {
    if(!r.ok) throw new Error('HTTP ' + r.status);
    status.textContent = "Position envoyée. Merci !";
    try{ window.parent.postMessage({action:'close'}, '*'); }catch(e){}
  })
  .catch(err => { status.textContent = "Erreur envoi: " + err.message; });
}

function error(err){
  status.textContent = "Impossible d'obtenir la position. Vérifie les permissions GPS.";
}
</script>
</body>
</html>
